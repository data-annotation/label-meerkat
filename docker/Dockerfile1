FROM python:3.10.10-bullseye
ARG PYPI=https://mirror.sjtu.edu.cn/pypi/web/simple

# RUN pip install 'clip@git+https://github.com/openai/CLIP.git@d50d76daa670286dd6cacf3bcd80b5e4823fc8e1'

COPY requirement-anno.txt requirement.txt

RUN pip install -r requirement.txt -i ${PYPI}

# RUN --mount=type=cache,mode=0777,target=/Users/jin/Library/Caches/pip

RUN echo "deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free \ndeb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free \ndeb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free \ndeb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free" > /etc/apt/sources.list
RUN apt-get update
RUN apt-get install -y vim

RUN wget "https://www.sqlite.org/2023/sqlite-autoconf-3410200.tar.gz" && tar xzf sqlite-autoconf-3410200.tar.gz \
    && cd sqlite-autoconf-3410200 && ./configure --disable-static --enable-fts5 --enable-json1 CFLAGS="-g -O2 -DSQLITE_ENABLE_FTS3=1 -DSQLITE_ENABLE_FTS4=1 -DSQLITE_ENABLE_RTREE=1 -DSQLITE_ENABLE_JSON1" \
    && make && make install

WORKDIR /anno
COPY services/ services
COPY all-MiniLM-L6-v2/ all-MiniLM-L6-v2
COPY data/ data

RUN mkdir label && \
    mkdir predict_result && \
    mkdir project && \
    mkdir model_data

ENV LD_LIBRARY_PATH="/usr/local/lib"

CMD uvicorn services.main:app --host 0.0.0.0



