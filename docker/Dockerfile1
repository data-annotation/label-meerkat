FROM python:3.10.10-bullseye
ARG PYPI=https://mirror.sjtu.edu.cn/pypi/web/simple
ARG DEBIAN=https://mirrors.tuna.tsinghua.edu.cn

# RUN pip install 'clip@git+https://github.com/openai/CLIP.git@d50d76daa670286dd6cacf3bcd80b5e4823fc8e1'

COPY requirement-anno.txt requirement.txt

RUN pip install -r requirement.txt -i ${PYPI}

# RUN --mount=type=cache,mode=0777,target=/Users/jin/Library/Caches/pip

RUN echo "deb ${DEBIAN}/debian/ bullseye main contrib non-free \ndeb ${DEBIAN}/debian/ bullseye-updates main contrib non-free \ndeb ${DEBIAN}/debian/ bullseye-backports main contrib non-free \ndeb ${DEBIAN}/debian-security bullseye-security main contrib non-free" > /etc/apt/sources.list
RUN apt-get update
RUN apt-get install -y vim

RUN curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
RUN apt-get install -y git-lfs
# RUN git lfs install

RUN wget "https://www.sqlite.org/2023/sqlite-autoconf-3410200.tar.gz" && tar xzf sqlite-autoconf-3410200.tar.gz \
    && cd sqlite-autoconf-3410200 && ./configure --disable-static --enable-fts5 --enable-json1 CFLAGS="-g -O2 -DSQLITE_ENABLE_FTS3=1 -DSQLITE_ENABLE_FTS4=1 -DSQLITE_ENABLE_RTREE=1 -DSQLITE_ENABLE_JSON1" \
    && make && make install

RUN rm sqlite-autoconf-3410200.tar.gz && rm -rf sqlite-autoconf-3410200

RUN git clone https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2

WORKDIR /anno
COPY services/ services


# COPY all-MiniLM-L6-v2/ all-MiniLM-L6-v2

COPY data/ data

RUN mkdir label && \
    mkdir predict_result && \
    mkdir project && \
    mkdir model_data

ENV LD_LIBRARY_PATH="/usr/local/lib"

RUN cd /anno && python -m services.orm.tables
RUN rm -r /root/.cache/pip

CMD uvicorn services.main:app --host 0.0.0.0



